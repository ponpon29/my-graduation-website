<div class="container">
  <div class="text-center mb-4">
    <% if @shop.photo_url.present? %>
      <%= image_tag @shop.photo_url, alt: "#{@shop.name}の画像", class: "img-fluid rounded mb-3", style: "max-width: 60%; height: auto;" %>
    <% end %>
    <h3 class="mb-3"><%= @shop.name %></h3>
    <p class="mb-2">⭐ <%= @shop.rating || '評価なし' %></p>

    <!-- 全てのボタンを横並びにする -->
    <div class="mb-3">
      <div class="d-flex justify-content-center gap-2 flex-wrap">
        
        <!-- ここに行くボタン -->
        <button onclick="navigateToShop({latitude: '<%= @shop.latitude %>', longitude: '<%= @shop.longitude %>', name: '<%= @shop.name %>'})" 
                class="btn btn-outline-success">
          <i class="fas fa-map-marker-alt me-2"></i>ここに行く
        </button>

        <!-- お気に入りボタン -->
        <div id="favorite-button-<%= @shop.id %>">           
          <% if current_user.present? %>
            <% if current_user.favorite?(@shop) %>
              <%= link_to shop_favorite_path(@shop), 
                          data: { turbo_method: :delete }, 
                          class: "btn btn-danger" do %>
                <i class="fas fa-heart me-1"></i>お気に入り解除
              <% end %>
            <% else %>
              <%= link_to shop_favorite_path(@shop),
                          data: { turbo_method: :post }, 
                          class: "btn btn-outline-danger" do %>
                <i class="far fa-heart me-1"></i>お気に入り
              <% end %>
            <% end %>
          <% else %>
            <%= link_to login_path, class: "btn btn-outline-secondary" do %>
              <i class="far fa-heart me-1"></i>お気に入り（ログインが必要）
            <% end %>
          <% end %>
        </div>
        
        <!-- 口コミ投稿ボタン -->
        <% if current_user.present? %>
          <%= link_to new_shop_review_path(@shop), class: "btn btn-outline-primary" do %>
            <i class="fas fa-edit me-1"></i>口コミを投稿
          <% end %>
        <% else %>
          <%= link_to login_path, class: "btn btn-outline-primary" do %>
            <i class="fas fa-edit me-1"></i>口コミを投稿（ログインが必要）
          <% end %>
        <% end %>
        
      </div>
    </div>

    <ul class="nav nav-tabs justify-content-center" id="shopTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
          店舗詳細
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
          口コミ一覧
        </button>
      </li>
    </ul>

    <div class="tab-content mt-3" id="shopTabsContent">
      <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
        <%= render 'shop_details', shop: @shop %>
      </div>

      <!-- 口コミ一覧タブ -->
      <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
        <%= render 'reviews_tab' %>
      </div>

      <div class="d-flex justify-content-center gap-3">
        <%= link_to "戻る", maps_path, class: "btn-ramen-hover" %>
      </div>
    </div>
  </div>
</div>

<script>
function navigateToShop(shop) {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;
      
      const url = `https://www.google.com/maps/dir/${userLat},${userLng}/${shop.latitude},${shop.longitude}`;
      window.open(url, '_blank');
    }, function(error) {
      alert('位置情報を取得できませんでした。目的地のみ表示します。');
      const url = `https://www.google.com/maps/search/?api=1&query=${shop.latitude},${shop.longitude}`;
      window.open(url, '_blank');
    });
  } else {
    alert('お使いのブラウザは位置情報に対応していません。');
    const url = `https://www.google.com/maps/search/?api=1&query=${shop.latitude},${shop.longitude}`;
    window.open(url, '_blank');
  }
}
</script>
