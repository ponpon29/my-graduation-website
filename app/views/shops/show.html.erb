<div class="container my-4">
  <div class="text-center mb-4">
    <% if @shop.photo_url.present? %>
      <div class="d-flex justify-content-center mb-3">
        <div style="max-width: 400px; width: 100%;">
          <%= image_tag @shop.photo_url,
              alt: t('defaults.shop_image_alt', name: @shop.name),
              class: "rounded shadow-sm w-100",
              style: "height: 300px; object-fit: cover;" %>
        </div>
      </div>
    <% end %>

    <h3 class="mb-2"><%= @shop.name %></h3>
    <p class="mb-2">⭐ <%= @shop.rating || t('defaults.no_rating') %></p>

    <div class="d-flex justify-content-center gap-2 flex-wrap mb-3">

      <% if @shop.latitude.present? && @shop.longitude.present? %>
        <button onclick="navigateToShop({
          latitude: '<%= @shop.latitude %>',
          longitude: '<%= @shop.longitude %>'
          })" class="btn btn-outline-success">
          <i class="fas fa-map-marker-alt me-1"></i>
          <%= t('defaults.navigate') %>
        </button>
      <% else %>
        <button class="btn btn-outline-secondary" disabled>
          <i class="fas fa-map-marker-alt me-1"></i>
          <%= t('defaults.no_location') %>
        </button>
      <% end %>

      <div id="favorite-button-<%= @shop.id %>">
        <% if current_user %>
          <% if current_user.favorite?(@shop) %>
            <%= link_to shop_favorite_path(@shop),
                data: { turbo_method: :delete, turbo_confirm: t('defaults.favorite_confirm') },
                class: "btn btn-danger" do %>
              <i class="fas fa-heart me-1"></i><%= t('defaults.remove_favorite') %>
            <% end %>
          <% else %>
            <%= link_to shop_favorite_path(@shop),
                data: { turbo_method: :post },
                class: "btn btn-outline-danger" do %>
              <i class="far fa-heart me-1"></i><%= t('defaults.add_favorite') %>
            <% end %>
          <% end %>
        <% else %>
          <%= link_to login_path, class: "btn btn-outline-secondary" do %>
            <i class="far fa-heart me-1"></i><%= t('defaults.favorite_login_required') %>
          <% end %>
        <% end %>
      </div>

      <% if current_user %>
        <%= link_to new_shop_review_path(@shop), class: "btn btn-outline-primary" do %>
          <i class="fas fa-edit me-1"></i><%= t('defaults.post_review') %>
        <% end %>
      <% else %>
        <%= link_to login_path, class: "btn btn-outline-primary" do %>
          <i class="fas fa-edit me-1"></i><%= t('defaults.review_login_required') %>
        <% end %>
      <% end %>
    </div>
  </div>

  <ul class="nav nav-tabs justify-content-center mb-3" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" 
            data-bs-toggle="tab" 
            data-bs-target="#details-tab" 
            type="button">
      <%= t('defaults.shop_details') %>
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" 
            data-bs-toggle="tab" 
            data-bs-target="#photos-tab" 
            type="button">
      写真
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" 
            data-bs-toggle="tab" 
            data-bs-target="#reviews-tab" 
            type="button">
      <%= t('defaults.reviews') %>
    </button>
  </li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade show active" id="details-tab">
    <%= render 'shop_details', shop: @shop %>
  </div>

  <div class="tab-pane fade" id="photos-tab">
    <%= render 'photos_tab', photos: @shop_photos %>
  </div>

  <div class="tab-pane fade" id="reviews-tab">
    <%= render 'reviews_tab' %>
  </div>
</div>

<script>
function navigateToShop(shop) {
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(function(position) {
    const url = `https://www.google.com/maps/dir/${position.coords.latitude},${position.coords.longitude}/${shop.latitude},${shop.longitude}`;
    window.open(url, '_blank');
  }, function() {
    const url = `https://www.google.com/maps/search/?api=1&query=${shop.latitude},${shop.longitude}`;
    window.open(url, '_blank');
  });
}
}
</script>
