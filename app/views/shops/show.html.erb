<div class="container">
  <!-- 店舗基本情報（タブ外） -->
  <div class="text-center mb-4">
    <% if @shop.photo_url.present? %>
      <%= image_tag @shop.photo_url, alt: "#{@shop.name}の画像", class: "img-fluid rounded mb-3", style: "max-width: 60%; height: auto;" %>
    <% end %>
    <h3 class="mb-3"><%= @shop.name %></h3>
    <p class="mb-2">⭐ <%= @shop.rating || '評価なし' %></p>

    <div class="mb-3">
  <!-- お気に入り機能 -->
  <% if current_user.present? %>
    <% if current_user.favorite?(@shop) %>
      <%= link_to unfavorite_shop_path(@shop), method: :delete, 
                  data: { turbo_method: :delete }, 
                  class: "btn btn-danger me-2" do %>
        <i class="fas fa-heart me-1"></i>お気に入り解除
      <% end %>
    <% else %>
      <%= link_to favorite_shop_path(@shop), method: :post, 
                  data: { turbo_method: :post }, 
                  class: "btn btn-outline-danger me-2" do %>
        <i class="far fa-heart me-1"></i>お気に入り
      <% end %>
    <% end %>
  <% else %>
    <!-- ログインしていない場合の表示 -->
    <%= link_to login_path, class: "btn btn-outline-secondary me-2" do %>
      <i class="far fa-heart me-1"></i>お気に入り（ログインが必要）
    <% end %>
  <% end %>
  
  <!-- ここに行くボタン -->
  <button onclick="navigateToShop({latitude: '<%= @shop.latitude %>', longitude: '<%= @shop.longitude %>', name: '<%= @shop.name %>'})" 
          class="btn btn-success">
    <i class="fas fa-map-marker-alt me-2"></i>ここに行く
  </button>
</div>

  <!-- タブナビゲーション -->
  <ul class="nav nav-tabs justify-content-center" id="shopTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
        店舗詳細
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
        口コミ投稿・一覧
      </button>
    </li>
  </ul>

  <!-- タブコンテンツ -->
  <div class="tab-content text-center" id="shopTabsContent">
    <!-- 店舗詳細タブ -->
    <div class="tab-pane fade show active" id="details" role="tabpanel">
      <%= render 'shop_details', shop: @shop %>
    </div>
  </div>

  <div class="d-flex justify-content-center gap-3">
    <%= link_to "戻る", maps_path, class: "btn-ramen-hover" %>
  </div>
</div>

<script>
// ここに行く機能
function navigateToShop(shop) {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;
      
      // Googleマップでルート案内を開く
      const url = `https://www.google.com/maps/dir/${userLat},${userLng}/${shop.latitude},${shop.longitude}`;
      window.open(url, '_blank');
    }, function(error) {
      // 位置情報取得に失敗した場合は目的地のみ表示
      alert('位置情報を取得できませんでした。目的地のみ表示します。');
      const url = `https://www.google.com/maps/search/?api=1&query=${shop.latitude},${shop.longitude}`;
      window.open(url, '_blank');
    });
  } else {
    // Geolocationが使用できない場合
    alert('お使いのブラウザは位置情報に対応していません。');
    const url = `https://www.google.com/maps/search/?api=1&query=${shop.latitude},${shop.longitude}`;
    window.open(url, '_blank');
  }
}
</script>
