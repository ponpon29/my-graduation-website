<% content_for :google_maps, true %>

<div class="container mt-3">
  <div class="text-center mb-4">
    
    <!-- ⭐ Ransack 検索フォーム -->
    <%= search_form_for @q, url: search_shop_path, method: :get do |f| %>
      <div class="d-flex align-items-center justify-content-center gap-2">
        
      <%= f.search_field :name_or_address_cont,
              class: "form-control",
              style: "width: 600px; max-width: 100%;",
              placeholder: "店名/住所で検索",
              id: "searchInput",
              autocomplete: "off" %>
        
      <%= button_tag "検索",
              type: "submit",
              class: "btn-ramen-hover",
              id: "searchBtn" %>
        
        <%= button_tag "現在地を表示",
              type: "button",
              class: "btn-ramen-hover ms-3",
              id: "getCurrentLocationBtn" %>
      </div>
    <% end %>
    
    <!-- ⭐ 検索結果の件数 -->
    <% if @keyword.present? %>
      <div class="alert alert-info mt-3 mb-0">
        「<strong><%= @keyword %></strong>」の検索結果: <%= @shops.count %>件
      </div>
    <% end %>
    
  </div>
</div>

<!-- 地図表示エリア -->
<div id="map" style="height: 700px; width: 100%;"></div>

<!-- ⭐ JavaScript（この1ファイルのみで完結） -->
<script>
(function() {
  'use strict';

  const shops = <%= raw @shops.to_json %>;

  let map, shopMarkers = [], sharedInfoWindow;

  // ⭐ ページ読み込み時に実行する処理
  window.pageInitMap = function() {
    console.log("Shop page: Map init");

    // 地図初期位置（博多駅）
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 33.590188, lng: 130.420685 },
      zoom: 14
    });

    sharedInfoWindow = new google.maps.InfoWindow();

    placeShopMarkers();
  };

  // ⭐ 店舗のマーカーを設置（標準赤ピン）
  function placeShopMarkers() {
    // 古いマーカー削除
    shopMarkers.forEach(m => m.setMap(null));
    shopMarkers = [];

    if (shops.length === 0) return;

    const bounds = new google.maps.LatLngBounds();

    shops.forEach(shop => {
      const lat = parseFloat(shop.latitude);
      const lng = parseFloat(shop.longitude);

      const marker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        title: shop.name
        // ← icon 無し → 標準赤ピン
      });

      const html = `
        <div style="max-width: 280px; padding: 10px;">
          <h5 style="margin-bottom: 8px; font-size: 16px;">${shop.name}</h5>
          <p style="margin: 5px 0; color: #666;">⭐ ${shop.rating || "評価なし"}</p>

          <div style="margin-top: 12px; display: flex; gap: 8px;">
            <button onclick="openShopModal(${shop.id})"
              class="btn btn-outline-primary btn-sm">
              <i class="fas fa-info-circle"></i> 詳細
            </button>

            <button onclick="navigateToShop({latitude:${lat},longitude:${lng}})"
              class="btn btn-outline-success btn-sm">
              <i class="fas fa-map-marker-alt"></i> ここに行く
            </button>
          </div>
        </div>
      `;

      marker.addListener("click", () => {
        sharedInfoWindow.setContent(html);
        sharedInfoWindow.open(map, marker);
      });

      shopMarkers.push(marker);
      bounds.extend(new google.maps.LatLng(lat, lng));
    });

    // ⭐ 複数ピン → 全てが画面内に入る
    if (shops.length > 1) {
      map.fitBounds(bounds);
    } else {
      map.setCenter(bounds.getCenter());
      map.setZoom(15);
    }
  }

  // ⭐ 経路案内
  function getCurrentLocation() {
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 8000
      });
    });
  }

  window.navigateToShop = async function(shop) {
    try {
      const pos = await getCurrentLocation();
      window.open(
        `https://www.google.com/maps/dir/${pos.coords.latitude},${pos.coords.longitude}/${shop.latitude},${shop.longitude}`,
        "_blank"
      );
    } catch {
      // 現在地拒否 → 通常検索
      window.open(
        `https://www.google.com/maps/search/?api=1&query=${shop.latitude},${shop.longitude}`,
        "_blank"
      );
    }
  };

  // ⭐ 詳細モーダル
  window.openShopModal = function(id) {
    const modal = new bootstrap.Modal(document.getElementById("shopDetailModal"));
    const body = document.getElementById("shopDetailContent");

    body.innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border"></div>
      </div>
    `;

    modal.show();

    fetch(`/shops/${id}?modal=true`, { headers: { Accept: "text/html" } })
      .then(res => res.text())
      .then(html => body.innerHTML = html)
      .catch(() => body.innerHTML = `<div class="alert alert-danger">読み込みエラー</div>`);
  };

})();
</script>

<!-- ⭐ Google Maps 読み込み（layout の initMap と連動） -->
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV["MAPS_API_KEY"] %>&callback=initMap" async defer></script>

<!-- ⭐ Modal -->
<div class="modal fade" id="shopDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="shopDetailContent"></div>
    </div>
  </div>
</div>