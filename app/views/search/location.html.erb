<% content_for :google_maps, true %>

<div class="container mt-3">
  <div class="text-center mb-4">
    <%= form_with url: search_location_path, method: :get, local: true, id: "searchForm" do |f| %>
      <div class="d-flex align-items-center justify-content-center gap-2">

        <%= f.search_field :q,
              value: params[:q],
              class: "form-control",
              style: "width: 600px; max-width: 100%;",
              placeholder: "場所/地名で検索",
              id: "searchInput",
              autocomplete: "off" %>

        <%= button_tag "検索",
              type: "button",
              class: "btn-ramen-hover",
              id: "searchBtn" %>

        <%= button_tag "現在地を表示",
              type: "button",
              class: "btn-ramen-hover ms-3",
              id: "getCurrentLocationBtn" %>

      </div>
    <% end %>
  </div>
</div>

<div id="map" style="height: 700px; width: 100%;"></div>

<script>
(function() {
  'use strict';

  const shops = <%= raw @shops.to_json %>;

  let map, placesService, autocomplete;
  let shopMarkers = [];
  let currentLocationMarker = null;
  let searchMarker = null;
  let sharedInfoWindow;

  // ⭐ ページ読み込み→まず現在地へ
  async function moveToCurrentLocationOnLoad() {
    try {
      const pos = await getCurrentLocation();

      const loc = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };

      map.setCenter(loc);
      map.setZoom(15);

      markCurrentLocation(loc);
    } catch {
      // 現在地が取れなかった → 博多駅にする
      const hakata = { lat: 33.590188, lng: 130.420685 };
      map.setCenter(hakata);
      map.setZoom(14);
    }
  }

  // ⭐ 現在地取得
  function getCurrentLocation() {
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 8000
      });
    });
  }

  // ⭐ 青ピンで現在地を表示
  function markCurrentLocation(loc) {
    if (currentLocationMarker) currentLocationMarker.setMap(null);

    currentLocationMarker = new google.maps.Marker({
      position: loc,
      map: map,
      title: "現在地",
      icon: {
        url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        scaledSize: new google.maps.Size(40, 40)
      }
    });
  }

  // ⭐ 施設検索（青ピン）
  function searchLocation() {
    const keyword = document.getElementById("searchInput").value.trim();
    if (!keyword) return;

    placesService.textSearch({ query: keyword }, (results, status) => {
      if (status !== google.maps.places.PlacesServiceStatus.OK || !results.length) {
        alert("該当する場所が見つかりませんでした");
        return;
      }

      const place = results[0];
      const loc = place.geometry.location;

      if (searchMarker) searchMarker.setMap(null);
      searchMarker = new google.maps.Marker({
        position: loc,
        map: map,
        title: place.name,
        icon: {
          url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          scaledSize: new google.maps.Size(40, 40)
        },
        animation: google.maps.Animation.DROP
      });

      sharedInfoWindow.setContent(`
        <div style="max-width: 260px; padding: 8px;">
          <h5 style="margin-bottom: 6px;">${place.name}</h5>
          <p style="color:#666;">${place.formatted_address || "住所情報なし"}</p>
        </div>
      `);
      sharedInfoWindow.open(map, searchMarker);

      map.setCenter(loc);
      map.setZoom(16);
    });
  }

  // ⭐ ラーメン店（標準赤ピン）
  function placeShopMarkers() {
    shopMarkers.forEach(m => m.setMap(null));
    shopMarkers = [];

    shops.forEach(shop => {
      const lat = parseFloat(shop.latitude);
      const lng = parseFloat(shop.longitude);

      const marker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        title: shop.name
      });

      const html = `
        <div style="max-width: 260px; padding: 8px;">
          <h5>${shop.name}</h5>
          <p style="color:#666;">⭐ ${shop.rating || "評価なし"}</p>
        </div>
      `;

      marker.addListener("click", () => {
        sharedInfoWindow.setContent(html);
        sharedInfoWindow.open(map, marker);
      });

      shopMarkers.push(marker);
    });
  }

  // ⭐ Google Maps 初期化
  window.pageInitMap = function() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 33.590188, lng: 130.420685 },
      zoom: 14
    });

    placesService = new google.maps.places.PlacesService(map);
    sharedInfoWindow = new google.maps.InfoWindow();

    // ラーメン店ピン
    placeShopMarkers();

    // ページ入った瞬間に現在地へ移動
    moveToCurrentLocationOnLoad();

    // 検索ボタン
    document.getElementById("searchBtn").addEventListener("click", searchLocation);

    // 現在地ボタン
    document.getElementById("getCurrentLocationBtn").addEventListener("click", async () => {
      try {
        const pos = await getCurrentLocation();
        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.setCenter(loc);
        map.setZoom(15);
        markCurrentLocation(loc);
      } catch {
        alert("現在地を取得できませんでした");
      }
    });
  };

})();
</script>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV["MAPS_API_KEY"] %>&libraries=places&callback=initMap"
        async defer></script>