<div class="container">
  <div class="row justify-content-center mb-4">
    <div class="col-lg-10 col-md-12">
      <div class="d-flex flex-wrap gap-2 justify-content-center align-items-center mb-2">
        <div class="flex-grow-1" style="min-width: 250px; max-width: 500px;">
          <input type="text" 
                id="searchInput" 
                class="form-control"
                placeholder="地名/場所で検索">
        </div>

        <button id="searchBtn" class="btn-ramen-hover">
          検索
        </button>
      </div>
  
      <div class="text-center">
        <button id="getCurrentLocationBtn" class="btn-ramen-hover">
          現在地を表示
        </button>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div id="map" class="flex-grow-1"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="shopDetailModal" tabindex="-1" aria-labelledby="shopDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="shopDetailContent">
        <div class="text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">読み込み中...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
#map {
  height: 700px;
  width: 100%;
}
</style>

<script>
let map;
let geocoder;
let placesService;
let currentLocationMarker;
let shopMarkers = [];
let sharedInfoWindow;
let searchMarker;
let autocomplete;

const shops = <%= raw @shops.to_json %>;
//  現在地取得
function getCurrentLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject();

    navigator.geolocation.getCurrentPosition(resolve, reject, {
      enableHighAccuracy: true,
      timeout: 10000
    });
  });
}
//  現在地に移動(ラーメン店は残す)
async function showCurrentLocation() {
  const btn = document.getElementById('getCurrentLocationBtn');
  btn.textContent = "取得中...";
  btn.disabled = true;

  try {
    const pos = await getCurrentLocation();
    const location = { lat: pos.coords.latitude, lng: pos.coords.longitude };

    if (currentLocationMarker) currentLocationMarker.setMap(null);

    currentLocationMarker = new google.maps.Marker({
      position: location,
      map: map,
      title: "現在地",
      icon: {
        url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        scaledSize: new google.maps.Size(40, 40)
      }
    });

    map.setCenter(location);
    map.setZoom(15);

  } catch {
    alert("現在地を取得できませんでした");
  }

  btn.textContent = "現在地を表示";
  btn.disabled = false;
}
//  オートコンプリートで場所を選択したときの処理
function onPlaceChanged() {
  const place = autocomplete.getPlace();

  // 場所の情報が取得できなかった場合
  if (!place.geometry || !place.geometry.location) {
    alert("選択した場所の情報を取得できませんでした");
    return;
  }

  // 前回の検索マーカーを削除
  if (searchMarker) {
    searchMarker.setMap(null);
  }

  const loc = place.geometry.location;

  // 検索結果に青いピンを立てる
  searchMarker = new google.maps.Marker({
    position: loc,
    map: map,
    title: place.name,
    icon: {
      url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
      scaledSize: new google.maps.Size(40, 40)
    },
    animation: google.maps.Animation.DROP
  });
  // InfoWindowで検索結果を表示(既存のスタイルを維持)
  sharedInfoWindow.setContent(`
    <div style="max-width: 280px; padding: 10px;">
      <h5 style="margin-bottom: 8px; font-size: 16px;">${place.name}</h5>
      <p style="margin: 5px 0; color: #666; font-size: 14px;">${place.formatted_address || '住所情報なし'}</p>
    </div>
  `);
  sharedInfoWindow.open(map, searchMarker);

  // 地図を移動
  map.setCenter(loc);

  // ビューポート(表示範囲)がある場合はそれに合わせる
  if (place.geometry.viewport) {
    map.fitBounds(place.geometry.viewport);
  } else {
    map.setZoom(16);
  }
}
//  Google Maps の検索 API(Places)
function searchLocation() {
  const keyword = document.getElementById("searchInput").value.trim();
  if (!keyword) return;

  // textSearch → Google マップ検索と同じ
  placesService.textSearch({ query: keyword }, (results, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
      const loc = results[0].geometry.location;

      // 前回の検索マーカーを削除
      if (searchMarker) {
        searchMarker.setMap(null);
      }

      // 検索結果に青いピンを立てる
      searchMarker = new google.maps.Marker({
        position: loc,
        map: map,
        title: results[0].name,
        icon: {
          url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          scaledSize: new google.maps.Size(40, 40)
        },
        animation: google.maps.Animation.DROP
      });

      // InfoWindowで検索結果を表示(既存のスタイルを維持)
      sharedInfoWindow.setContent(`
        <div style="max-width: 280px; padding: 10px;">
          <h5 style="margin-bottom: 8px; font-size: 16px;">${results[0].name}</h5>
          <p style="margin: 5px 0; color: #666; font-size: 14px;">${results[0].formatted_address || '住所情報なし'}</p>
        </div>
      `);
      sharedInfoWindow.open(map, searchMarker);

      map.setCenter(loc);
      map.setZoom(15);
    } else {
      alert("該当する場所が見つかりませんでした");
    }
  });
}
//  店舗へ経路案内
async function navigateToShop(shop) {
  try {
    const pos = await getCurrentLocation();
    window.open(
      `https://www.google.com/maps/dir/${pos.coords.latitude},${pos.coords.longitude}/${shop.latitude},${shop.longitude}`,
      "_blank"
    );
  } catch {
    window.open(
      `https://www.google.com/maps/search/?api=1&query=${shop.latitude},${shop.longitude}`,
      "_blank"
    );
  }
}
//  モーダルで店舗詳細を表示
function openShopModal(shopId) {
  const modal = new bootstrap.Modal(document.getElementById('shopDetailModal'));
  const modalBody = document.getElementById('shopDetailContent');
  // ローディング表示
  modalBody.innerHTML = `
    <div class="text-center py-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">読み込み中...</span>
      </div>
    </div>
  `;

  modal.show(); 
  // 詳細を取得
  fetch(`/shops/${shopId}?modal=true`, {
    headers: {
      'Accept': 'text/html'
    }
  })
  .then(response => response.text())
  .then(html => {
    modalBody.innerHTML = html;
  })
  .catch(error => {
    modalBody.innerHTML = `
      <div class="alert alert-danger">
        エラーが発生しました。もう一度お試しください。
      </div>
    `;
  });
}
//  Google Map 初期化
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 33.590188, lng: 130.420685 }, // 博多
    zoom: 14
  });

  geocoder = new google.maps.Geocoder();
  placesService = new google.maps.places.PlacesService(map);
  sharedInfoWindow = new google.maps.InfoWindow();
  //  オートコンプリート設定
  const searchInput = document.getElementById("searchInput");

  autocomplete = new google.maps.places.Autocomplete(searchInput, {
    componentRestrictions: { country: 'jp' }, // 日本に限定
    fields: ['geometry', 'name', 'formatted_address'], // 取得する情報を指定
    types: ['geocode', 'establishment'] // 住所と施設の両方を候補に含める
  });
  // マップとオートコンプリートを連動(現在の表示範囲を優先)
  autocomplete.bindTo('bounds', map);
  // 場所が選択されたときのイベント
  autocomplete.addListener('place_changed', onPlaceChanged);
  //  イベントリスナー設定
  document.getElementById("getCurrentLocationBtn").addEventListener("click", showCurrentLocation);
  document.getElementById("searchBtn").addEventListener("click", searchLocation);

  // Enter でも検索
  document.getElementById("searchInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      // オートコンプリートの候補が表示されている場合は選択、なければ通常検索
      const place = autocomplete.getPlace();
      if (!place || !place.geometry) {
        searchLocation();
      }
    }
  });
  //  ラーメン店マーカー(全表示)
  shops.forEach((shop) => {
    const lat = parseFloat(shop.latitude);
    const lng = parseFloat(shop.longitude);

    const marker = new google.maps.Marker({
      position: { lat, lng },
      map: map,
      title: shop.name
    });
    // InfoWindow用のHTML(既存のスタイルを維持)
    const contentHtml = `
      <div style="max-width: 280px; padding: 10px;">
        <h5 style="margin-bottom: 8px; font-size: 16px;">${shop.name}</h5>
        <p style="margin: 5px 0; color: #666;">⭐ ${shop.rating || '評価なし'}</p>
        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button 
            onclick="openShopModal(${shop.id})" 
            class="btn btn-outline-primary btn-sm">
            <i class="fas fa-info-circle"></i> 詳細を見る
          </button>
          <button 
            onclick="navigateToShop({latitude: '${shop.latitude}', longitude: '${shop.longitude}', name: '${shop.name}'})" 
            class="btn btn-outline-success btn-sm">
            <i class="fas fa-map-marker-alt"></i> ここに行く
          </button>
        </div>
      </div>
    `;
    // マーカークリックでInfoWindow表示
    marker.addListener("click", () => {
      sharedInfoWindow.setContent(contentHtml);
      sharedInfoWindow.open(map, marker);
    });

    shopMarkers.push(marker);
  });
}
// Google Maps API読み込み後に実行
window.initMap = initMap;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['MAPS_API_KEY'] %>&libraries=places&callback=initMap" async defer></script>

<meta name="apple-mobile-web-app-capable" content="yes">